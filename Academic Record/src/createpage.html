<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SignUp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/src/css/create_page.css"/>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  </head>
  <body>
    <div class="login-page">
      <div class="login-container">
        <div class="login-title">Create an Account</div>
        <form class="login-form" id="createForm">
          <div class="input-field">
            <label for="full-name">Full name</label>
            <input type="text" id="full-name" name="full-name" required />
          </div>
          <div class="input-field">
            <label for="email-address">Email Address</label>
            <input type="email" id="email-address" name="email-address" required />
          </div>
          <div class="input-field">
            <label for="select-role">Select Role</label>
            <select id="select-role" name="select-role" onchange="toggleRoleInput()" required>
              <option value="" selected>Select your role</option>
              <option value="lecturer">Lecturer</option>
              <option value="student">Student</option>
            </select>
          </div>
          <div class="input-field" id="matriculation-number-field" style="display: none;">
            <label for="matriculation-number">Matriculation Number</label>
            <input type="text" id="matriculation-number" name="matriculation-number" />
          </div>
          <div class="input-field" id="staff-id-field" style="display: none;">
            <label for="staff-id">Staff ID</label>
            <input type="text" id="staff-id" name="staff-id" />
          </div>
          <button type="submit" class="primary-button">Create</button>
        </form>
      </div>
    </div>
    <script>
      function toggleRoleInput() {
        const role = document.getElementById('select-role').value;
        const matriculationField = document.getElementById('matriculation-number-field');
        const staffIdField = document.getElementById('staff-id-field');
        const matriculationInput = document.getElementById('matriculation-number');
        const staffIdInput = document.getElementById('staff-id');

        if (role === 'student') {
          matriculationField.style.display = 'block';
          matriculationInput.setAttribute('required', 'true');
          staffIdField.style.display = 'none';
          staffIdInput.removeAttribute('required');
        } else if (role === 'lecturer') {
          matriculationField.style.display = 'none';
          matriculationInput.removeAttribute('required');
          staffIdField.style.display = 'block';
          staffIdInput.setAttribute('required', 'true');
        } else {
          matriculationField.style.display = 'none';
          matriculationInput.removeAttribute('required');
          staffIdField.style.display = 'none';
          staffIdInput.removeAttribute('required');
        }
      }

      document.getElementById('createForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        
        const fullName = document.getElementById('full-name').value;
        const emailAddress = document.getElementById('email-address').value;
        const role = document.getElementById('select-role').value;
        const matriculationNumber = document.getElementById('matriculation-number').value;
        const staffId = document.getElementById('staff-id').value;

        if (typeof window.ethereum !== 'undefined') {
          try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];
            console.log('Connected account:', account);

            const web3 = new Web3(window.ethereum);
            const contractAddress = '0x51c253390442E5e1710b57d920Be0009D4f98145';
            const contractABI = [
              // ABI content here
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "studentAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "courseCode",
          "type": "string"
        }
      ],
      "name": "CourseRegistered",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "lecturerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "studentAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "courseCode",
          "type": "string"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "finalGrade",
          "type": "string"
        }
      ],
      "name": "GradeUploaded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "lecturerAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "staffID",
          "type": "string"
        }
      ],
      "name": "LecturerRegistered",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "studentAddress",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "matriculationNumber",
          "type": "string"
        }
      ],
      "name": "StudentRegistered",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "lecturers",
      "outputs": [
        {
          "internalType": "string",
          "name": "staffID",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "email",
          "type": "string"
        },
        {
          "internalType": "bool",
          "name": "isRegistered",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "name": "matricToStudentAddress",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "name": "studentGrades",
      "outputs": [
        {
          "internalType": "string",
          "name": "courseCode",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "testScore",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "examScore",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "totalScore",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "finalGrade",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "students",
      "outputs": [
        {
          "internalType": "string",
          "name": "matriculationNumber",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "email",
          "type": "string"
        },
        {
          "internalType": "bool",
          "name": "isRegistered",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_matriculationNumber",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_email",
          "type": "string"
        }
      ],
      "name": "registerStudent",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_staffID",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_email",
          "type": "string"
        }
      ],
      "name": "registerLecturer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_courseCode",
          "type": "string"
        }
      ],
      "name": "registerCourse",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_matriculationNumber",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_courseCode",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_testScore",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_examScore",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_totalScore",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_finalGrade",
          "type": "string"
        }
      ],
      "name": "uploadGrade",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_courseCode",
          "type": "string"
        }
      ],
      "name": "checkResult",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    }
            ];
            const contract = new web3.eth.Contract(contractABI, contractAddress);

            const isRegistered = await contract.methods.isRegistered(account).call();

            if (isRegistered) {
              alert('Wallet address already registered. Redirecting to login page.');
              window.location.href = '/src/loginpage.html';
              return;
            }

            if (role === 'student') {
              await contract.methods.registerStudent(matriculationNumber, fullName, emailAddress).send({ from: account });
              window.location.href = '/src/student_dashboard.html';
            } else if (role === 'lecturer') {
              await contract.methods.registerLecturer(staffId, fullName, emailAddress).send({ from: account });
              window.location.href = '/src/staff_dashboard.html';
            } else {
              alert('Please select a role');
            }
          } catch (error) {
            console.error('An error occurred:', error);
            alert('An error occurred while creating the account. Please try again.');
          }
        } else {
          alert('MetaMask is not installed. Please install MetaMask and try again.');
        }
      });
    </script>
  </body>
</html>
